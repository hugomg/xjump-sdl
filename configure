#!/bin/sh

version='3.0'

#
# Functions
#

error() {
    echo >&2 "$1"
    exit 1
}

usage() {
    cat <<EOF
Usage: $0 [OPTION]... [VAR=VALUE]...

Configure the installation location and compilation options for Xjump.
By default, \`make install' will install all the files under /usr/local.
Use the \`--prefix' flag to choose a different location. Defaults for the
options are specified in brackets.

To set compilation variables (e.g. CC, CFLAGS...), specify them as VAR=VALUE.
See below for descriptions of some of the relevant variables. We use pkg-config
to determine the default value for these variables.

General:
    -h, --help         display this help and exit

Instalation directories:
    --prefix=PREFIX    root installation directory [/usr/local]

    --bindir=DIR       where to install the game executable [PREFIX/bin]
    --datadir=DIR      where to install the game sprites [PREFIX/share]

Compilation variables:
    CC                 C compiler command
    CFLAGS             C compiler flags (-O2 -Wall ...)
    CPPFLAGS           C preprocessor flags (-I<dir> ...)

    LDFLAGS            Linker flags (-L<dir> ...)
    LIBS               Libraries (-l<library> ...)

    SDL2_CFLAGS        Additional flags for compiling with SDL2
    SDL2_LIBS          Additional flags for linking with SDL2
EOF
}

escape_c() {
    printf "%s" "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g'
}

escape_make() {
    printf "%s" "$1" | sed -e 's/\\/\\\\/g' -e 's/\$/$$/g' -e 's/#/\\#/g'
}

nl='
'

# Command-line parsing
# To keep things simple we require that options take the form `--key=v`
prefix=
bindir=
datadir=
variables=
set_sdl_cflags=no
set_sdl_libs=no
for arg in "$@"; do
    key="${arg%%=*}"
    value="${arg#*=}"
    case "$arg" in
        -h|--help)   usage; exit 0;;
        --prefix=*)  prefix=$value;;
        --bindir=*)  bindir=$value;;
        --datadir=*) datadir=$value;;
        --*) error "Unrecognized option $arg";;
        *=*)
            line="${key} = $(escape_make "$value")"
            variables="${variables}${nl}${line}"
            if [ "$key" = "SDL_CFLAGS" ]; then set_sdl_cflags=yes; fi
            if [ "$key" = "SDL_LIBS" ];   then set_sdl_libs=yes; fi
            ;;
    esac
done

# Check for the required dependencies. As a concession for people who don't
# have pkg-config set up, assume that the library is installed if the user is
# setting the relevant compilation flags by hand.
if [ "$set_sdl_cflags" = no ] || [ "$set_sdl_libs" = no ]; then
    if ! pkg-config sdl2 --exists; then
        cat >&2 <<EOF
ERROR: pkg-config could not find the header files for SDL2.
If the dev package of SDL2 is not already installed, please install it first.
If it is already installed, please call configure again specifying values for
SDL_CFLAGS and SDL_LIBS so that we can know where to find it.
EOF
        exit 1
    fi
fi

# Now we compute the final values of the installation directories. Since this
# information will be included in the config.h, we have to figure out the
# absolute paths to them right now. We don't want to give the impression that
# the user can override the prefix later with `make prefix=blah`.
[ -n "$prefix"  ] || prefix="/usr/local"
[ -n "$bindir"  ] || bindir="$prefix/bin"
[ -n "$datadir" ] || datadir="$prefix/datadir"

prefix=$(readlink -f "$prefix")
bindir=$(readlink -f "$bindir")
datadir=$(readlink -f "$datadir")

# Finally, store the information where the makefile can see it and tell the
# user where things are going to be installed.
cat > config.mk <<EOF
# Generated by the ./configure script
version = $(escape_make "$version")
prefix  = $(escape_make "$prefix")
bindir  = $(escape_make "$bindir")
datadir = $(escape_make "$datadir")$variables
EOF

cat > config.h <<EOF
/* Generated by the ./configure script */
#define XJUMP_VERSION "$(escape_c "$version")"
#define XJUMP_PREFIX  "$(escape_c "$prefix")"
#define XJUMP_BINDIR  "$(escape_c "$bindir")"
#define XJUMP_DATADIR "$(escape_c "$datadir")"
EOF

cat <<EOF
Configuration sucessful.
Run \`make\` and \`sudo make install\` to continue the installation.

Xjump will be installed to        : ${prefix}
Xjump will install executables in : ${bindir}
Xjump will install data files in  : ${datadir}$variables
EOF

exit 0
