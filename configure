#!/bin/sh

version='3.0'

#
# Functions
#

error() {
    echo >&2 "$1"
    exit 1
}

usage() {
    cat <<EOF
Usage: $0 [OPTION]... [VAR=VALUE]...

Configure the installation location and compilation options for Xjump.
By default, \`make install' will install all the files under /usr/local.
Use the \`--prefix' flag to choose a different location. Defaults for the
options are specified in brackets.

To set compilation variables (e.g. CC, CFLAGS...), specify them as VAR=VALUE.
See below for descriptions of some of the relevant variables. We use pkg-config
to determine the default value for these variables.

General:
    -h, --help         display this help and exit

Instalation directories:
    --prefix=PREFIX    root installation directory [/usr/local]

    --bindir=DIR       where to install the game executable [PREFIX/bin]
    --datadir=DIR      where to install the game sprites [PREFIX/share]

Compilation variables:
    CC                 C compiler command
    CFLAGS             C compiler flags (-O2 -Wall ...)
    CPPFLAGS           C preprocessor flags (-I<dir> ...)

    LDFLAGS            Linker flags (-L<dir> ...)
    LIBS               Libraries (-l<library> ...)

    SDL2_CFLAGS        Additional flags for compiling with SDL2
    SDL2_LIBS          Additional flags for linking with SDL2
EOF
}

escape_c() {
    printf "%s" "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g'
}

escape_make() {
    printf "%s" "$1" | sed -e 's/\\/\\\\/g' -e 's/\$/$$/g' -e 's/#/\\#/g'
}

nl='
'

# Command-line parsing
# To keep things simple we require that options take the form `--key=v`
prefix=
bindir=
datadir=
variables=
for arg in "$@"; do
    key="${arg%%=*}"
    value="${arg#*=}"
    case "$arg" in
        -h|--help)   usage; exit 0;;
        --prefix=*)  prefix=$value;;
        --bindir=*)  bindir=$value;;
        --datadir=*) datadir=$value;;
        --*) error "Unrecognized option $arg";;
        *=*)
            line="${key} = $(escape_make "$value")${nl}"
            variables="${variables}${line}"
            ;;
    esac
done

# Now we compute the final values of the instalation directories. Since this
# information will be included in the config.h, we have to figure out the
# absolute paths to them right now. We don't want to give the impression that
# the user can override the prefix later with `make prefix=blah`.
[ -n "$prefix"  ] || prefix=$(readlink -f "/usr/local")
[ -n "$bindir"  ] || bindir=$(readlink -f "$prefix/bin")
[ -n "$datadir" ] || datadir=$(readlink -f "$prefix/datadir")

cat > config.mk <<EOF
# Generated by the ./configure script
version = $(escape_make "$version")
prefix  = $(escape_make "$prefix")
bindir  = $(escape_make "$bindir")
datadir = $(escape_make "$datadir")
$variables
EOF

cat > config.h <<EOF
/* Generated by the ./configure script */
#define XJUMP_VERSION "$(escape_c "$version")"
#define XJUMP_DATADIR "$(escape_c "$datadir")"
EOF

cat <<EOF
Configuration sucessful.
Run \`make\` and \`sudo make install\` to continue the installation.

Xjump will be installed to        : ${prefix}
Xjump will install executables in : ${bindir}
Xjump will install data files in  : ${datadir}
EOF
if [ -n "$variables" ]; then
    printf "%s" "$variables"
fi

exit 0
